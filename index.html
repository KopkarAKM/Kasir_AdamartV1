<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Kasir Hybrid (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Konfigurasi Firebase (JANGAN DIUBAH)
        const firebaseConfig = {
            apiKey: "AIzaSyBApyoL7sczxl1kDq_WgPtnYF4lyujuWgc",
            authDomain: "adamart-pos.firebaseapp.com",
            projectId: "adamart-pos",
            storageBucket: "adamart-pos.firebasestorage.app",
            messagingSenderId: "754641758734",
            appId: "1:754641758734:web:8eaa07cf10ead6ea02aa5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Expose ke window agar bisa dipanggil fungsi biasa
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.query = query;
        window.where = where;
        window.increment = increment;
        
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        tailwind.config = { theme: { extend: { colors: { 'adamart': { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } } } } }
    </script>
    <style>
        body { box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .loading { animation: pulse 2s infinite; }
        .product-card { transition: all 0.2s ease; }
        .product-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- 1. AREA SELECTION (Halaman Depan) -->
    <div id="areaSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 card-shadow max-w-md w-full">
            <div class="text-center mb-8"><div class="text-6xl mb-4">‚ö°</div><h1 class="text-2xl font-bold text-gray-800 mb-2">Adamart Hybrid</h1><p class="text-gray-600">Sistem Kasir Real-time</p></div>
            <div class="space-y-4">
                <button onclick="selectArea('adamart 73')" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl hover:scale-105 transition-all flex justify-between items-center"><div class="flex items-center gap-3"><span class="text-2xl">üè¢</span><div class="text-left font-semibold">Adamart 73<div class="text-xs font-normal opacity-90">Area Utama</div></div></div><span>‚Üí</span></button>
                <button onclick="selectArea('adamart induksi')" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl hover:scale-105 transition-all flex justify-between items-center"><div class="flex items-center gap-3"><span class="text-2xl">‚ö°</span><div class="text-left font-semibold">Adamart Induksi<div class="text-xs font-normal opacity-90">Area Induksi</div></div></div><span>‚Üí</span></button>
                <button onclick="selectArea('adamart kelanis')" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-xl hover:scale-105 transition-all flex justify-between items-center"><div class="flex items-center gap-3"><span class="text-2xl">üåü</span><div class="text-left font-semibold">Adamart Kelanis<div class="text-xs font-normal opacity-90">Area Kelanis</div></div></div><span>‚Üí</span></button>
            </div>
        </div>
    </div>

    <!-- 2. LOADING SCREEN -->
    <div id="loadingScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="text-center"><div class="loading bg-adamart-500 w-16 h-16 rounded-full mx-auto mb-4"></div><h3 class="text-xl font-bold text-gray-800">Menghubungkan...</h3></div>
    </div>

    <!-- 3. INTERFACE KASIR UTAMA -->
    <div id="cashierInterface" class="hidden flex flex-col h-screen">
        <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-3 shadow-lg shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="changeArea()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30">üîÑ</button>
                    <div><h1 class="text-lg font-bold">Adamart POS</h1><p id="currentArea" class="text-xs opacity-90 font-mono">-</p></div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Info Shift Aktif -->
                    <div class="hidden md:block bg-white/10 px-3 py-1 rounded text-xs">
                        Kasir: <span id="headerCashierName" class="font-bold">-</span>
                    </div>
                    
                    <button onclick="showReceivingModal()" class="bg-purple-500 px-3 py-1.5 rounded text-xs font-bold hover:bg-purple-600">üì¶ Terima</button>
                    <button onclick="showRequisitionModal()" class="bg-orange-500 px-3 py-1.5 rounded text-xs font-bold hover:bg-orange-600">üìù Req</button>
                    <!-- TOMBOL TUTUP SHIFT -->
                    <button onclick="closeShiftModal()" class="bg-red-500 px-3 py-1.5 rounded text-xs font-bold hover:bg-red-600 border border-red-400">üõë Tutup Shift</button>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Kiri: Produk -->
            <div class="flex-1 flex flex-col p-4 overflow-hidden bg-gray-50">
                <div class="bg-white p-3 rounded-lg shadow mb-3 flex gap-2">
                    <input type="text" id="productSearch" placeholder="üîç Cari nama / scan barcode..." class="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500">
                    <select id="productSelect" class="w-40 p-2 border rounded text-sm bg-white"><option value="">Manual...</option></select>
                </div>
                <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto pr-1 pb-20"></div>
            </div>

            <!-- Kanan: Keranjang -->
            <div class="w-96 bg-white shadow-xl flex flex-col border-l border-gray-200 z-20">
                <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">üõí Keranjang</h3>
                    <button onclick="clearCart()" class="text-red-500 text-xs font-bold">Hapus Semua</button>
                </div>
                <div id="cartItems" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex justify-between font-bold text-xl mb-3 text-gray-800"><span>Total</span><span id="totalAmount">Rp 0</span></div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button onclick="selectPaymentMethod('Tunai')" id="payTunai" class="payment-btn bg-white border p-2 rounded text-xs font-bold hover:bg-blue-50">üíµ Tunai</button>
                        <button onclick="selectPaymentMethod('QRIS')" id="payQRIS" class="payment-btn bg-white border p-2 rounded text-xs font-bold hover:bg-blue-50">üì± QRIS</button>
                        <button onclick="selectPaymentMethod('Kasbon')" id="payKasbon" class="payment-btn bg-white border p-2 rounded text-xs font-bold hover:bg-blue-50">üìù Kasbon</button>
                    </div>
                    <!-- Tombol Bayar -->
                    <button onclick="processTransaction()" id="checkoutBtn" disabled class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:bg-gray-300 shadow-lg hover:bg-blue-700 transition">Bayar Sekarang</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODAL - MODAL ================= -->

    <!-- 1. MODAL BUKA SHIFT (WAJIB MUNCUL JIKA BELUM BUKA) -->
    <div id="openShiftModal" class="fixed inset-0 bg-gray-900 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-8 w-full max-w-md text-center shadow-2xl border-4 border-blue-500">
            <div class="text-4xl mb-4">‚òÄÔ∏è</div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Buka Shift Baru</h2>
            <p class="text-gray-500 mb-6 text-sm">Masukkan nama Anda dan hitung modal awal di laci.</p>
            <form onsubmit="startShift(event)" class="space-y-4 text-left">
                <div>
                    <label class="font-bold text-xs text-gray-600 uppercase">Nama Kasir</label>
                    <input type="text" id="shiftCashier" class="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500" required placeholder="Contoh: Budi">
                </div>
                <div>
                    <label class="font-bold text-xs text-gray-600 uppercase">Modal Awal (Rp)</label>
                    <input type="number" id="startCash" class="w-full p-3 border rounded-lg font-mono text-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500" required placeholder="0">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg">üöÄ Buka Toko</button>
            </form>
        </div>
    </div>

    <!-- 2. MODAL TUTUP SHIFT -->
    <div id="closeShiftModal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-lg mb-4 border-b pb-2 text-gray-800">üõë Laporan Tutup Shift</h3>
            <div class="space-y-2 mb-4 text-sm text-gray-600">
                <div class="flex justify-between"><span>Kasir:</span> <span class="font-bold text-gray-900" id="cs-name">-</span></div>
                <div class="flex justify-between"><span>Waktu Buka:</span> <span id="cs-time">-</span></div>
                <div class="flex justify-between"><span>Modal Awal:</span> <span id="cs-start">0</span></div>
                <div class="border-t border-dashed my-2 pt-2">
                    <div class="flex justify-between text-blue-600 font-bold"><span>(+) Penjualan Tunai:</span> <span id="cs-sales">0</span></div>
                    <div class="flex justify-between"><span>(i) Total QRIS:</span> <span id="cs-qris">0</span></div>
                    <div class="flex justify-between"><span>(i) Total Kasbon:</span> <span id="cs-kasbon">0</span></div>
                </div>
                <div class="flex justify-between font-bold text-lg border-t pt-2 bg-gray-100 p-2 rounded">
                    <span>Harus Ada Fisik:</span> <span id="cs-expected">0</span>
                </div>
            </div>
            <form onsubmit="finishShift(event)">
                <div class="mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                    <label class="block text-xs font-bold text-yellow-800 mb-1">HITUNG UANG FISIK DI LACI</label>
                    <input type="number" id="actualCash" class="w-full p-2 border rounded font-mono text-lg font-bold text-right" required placeholder="0">
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('closeShiftModal').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 rounded font-bold text-gray-600">Batal</button>
                    <button type="submit" class="flex-1 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700 shadow">Simpan & Tutup</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. MODAL KASBON (INTEGRASI E-VOUCHER) -->
    <div id="kasbonModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md relative shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800">üí≥ Pembayaran Kasbon</h3>
                <button onclick="closeKasbonModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>

            <!-- Loading Overlay untuk Cek User -->
            <div id="kasbonLoading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center z-10 rounded-xl">
                <div class="flex flex-col items-center">
                    <div class="animate-spin text-3xl mb-2">‚è≥</div>
                    <span class="text-sm font-bold text-gray-600">Menghubungkan ke Server E-Voucher...</span>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Input Pencarian -->
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Cari Anggota (NIK / No Anggota)</label>
                    <div class="flex gap-2">
                        <input type="text" id="kasbonSearchId" placeholder="Contoh: 41069" class="w-full p-2 border rounded font-mono font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" onclick="checkEvoucherUser()" class="bg-blue-600 text-white px-4 rounded font-bold hover:bg-blue-700">Cek</button>
                    </div>
                </div>

                <!-- Hasil Pencarian User -->
                <div id="evUserInfo" class="hidden bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Nama Anggota</p>
                            <p class="font-bold text-gray-800 text-lg leading-tight" id="evUserName">-</p>
                            <p class="text-xs text-gray-500 mt-1">NIK: <span id="evUserNIK" class="font-mono">-</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500 uppercase font-bold">Sisa Limit</p>
                            <p class="font-bold text-green-600 text-xl" id="evUserLimit">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Ringkasan Belanja -->
                <div class="flex justify-between items-center py-2 border-t border-dashed">
                    <span class="text-gray-600 font-bold">Total Belanja:</span>
                    <span class="text-xl font-bold text-gray-800" id="evTotalAmountDisplay">Rp 0</span>
                </div>
                
                <!-- Hidden Input untuk simpan data user yg ditemukan -->
                <input type="hidden" id="evFoundUser" value="">

                <button onclick="processKasbonTransaction()" id="evSubmitBtn" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Konfirmasi Pembayaran
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL LAINNYA (Receipt, Receiving, dll) -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-xl p-6 w-full max-w-md"><div class="text-center mb-4 text-green-600 font-bold text-lg">‚úÖ Transaksi Berhasil</div><div id="receiptContent" class="bg-gray-50 p-4 rounded-lg text-sm mb-4 font-sans"></div><div class="flex gap-3"><button onclick="closeReceiptModal()" class="flex-1 py-2 bg-gray-200 rounded-lg">Tutup</button><button onclick="sendToWhatsApp()" class="flex-1 py-2 bg-green-600 text-white rounded-lg">Kirim WA</button></div></div></div>
    <div id="toast" class="hidden fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl z-[80] animate-bounce"></div>
    <!-- (Modal Receiving & Requisition disederhanakan di sini agar tidak terlalu panjang, tapi fungsinya ada di JS) -->
    
    <script>
        // --- KONFIGURASI URL ---
        const POS_API_URL = 'https://script.google.com/macros/s/AKfycbwkZVsoGXdgxck4xwOXk2fW4Oawn6diXu2bUX0sAIRFCfGeS1jTr6QjEH6Fr6-RFbnDAw/exec';
        const EVOUCHER_API_URL = "https://script.google.com/macros/s/AKfycbyQFkZW0QuBXi082jgXTsVBIy1OfVfhaQYVogvr7uBJBrCuGtkM73tTGqA1dl9ThlfL/exec";

        // --- GLOBAL VARIABLES ---
        let currentArea = '', availableProducts = [], cart = [], selectedPaymentMethod = '', lastTransaction = null;
        let activeShift = null;
        let evoucherUsers = []; // Cache user E-Voucher

        // --- HELPER FUNCTIONS ---
        function formatRp(n) { return "Rp " + (n || 0).toLocaleString('id-ID'); }
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-xl z-[80] animate-bounce ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        // --- SHIFT MANAGEMENT LOGIC (WAJIB ADA) ---
        function initShift() {
            const savedShift = localStorage.getItem('adamart_shift');
            if (savedShift) {
                activeShift = JSON.parse(savedShift);
                // Update UI Header
                const headerName = document.getElementById('headerCashierName');
                if(headerName) headerName.textContent = activeShift.cashierName;
                
                document.getElementById('openShiftModal').classList.add('hidden');
            } else {
                document.getElementById('openShiftModal').classList.remove('hidden'); // Paksa buka modal
            }
        }

        function startShift(e) {
            e.preventDefault();
            const name = document.getElementById('shiftCashier').value;
            const cash = parseInt(document.getElementById('startCash').value);
            
            if(!name || isNaN(cash)) return alert("Mohon isi nama dan modal awal.");

            const shiftData = {
                id: 'SHIFT-' + Date.now(),
                cashierName: name,
                startCash: cash,
                startTime: new Date().toISOString(),
                area: currentArea
            };
            
            localStorage.setItem('adamart_shift', JSON.stringify(shiftData));
            activeShift = shiftData;
            
            initShift(); // Refresh UI
            showToast(`Shift dibuka oleh ${name}`);
        }

        async function closeShiftModal() {
            if (!activeShift) return alert("Shift belum dibuka!");
            
            // Hitung penjualan tunai dari memory/firebase
            // (Untuk simplifikasi, di sini kita query firebase, tapi di real-time app sebaiknya simpan di local juga)
            const q = window.query(
                window.collection(window.db, "sales"),
                window.where("shiftId", "==", activeShift.id)
            );
            
            const snap = await window.getDocs(q);
            let cashSales = 0, qrisSales = 0, kasbonSales = 0;

            snap.forEach(doc => { 
                const s = doc.data();
                if (s.method === 'Tunai') cashSales += s.total;
                else if (s.method === 'QRIS') qrisSales += s.total;
                else if (s.method === 'Kasbon') kasbonSales += s.total;
            });

            const expected = activeShift.startCash + cashSales;
            
            // Update UI Modal
            document.getElementById('cs-name').textContent = activeShift.cashierName;
            document.getElementById('cs-time').textContent = new Date(activeShift.startTime).toLocaleTimeString();
            document.getElementById('cs-start').textContent = formatRp(activeShift.startCash);
            document.getElementById('cs-sales').textContent = formatRp(cashSales);
            document.getElementById('cs-qris').textContent = formatRp(qrisSales);
            document.getElementById('cs-kasbon').textContent = formatRp(kasbonSales);
            document.getElementById('cs-expected').textContent = formatRp(expected);
            
            // Simpan data sementara di elemen modal
            const modal = document.getElementById('closeShiftModal');
            modal.dataset.expected = expected;
            modal.dataset.cashSales = cashSales;
            modal.dataset.qrisSales = qrisSales;
            modal.dataset.kasbonSales = kasbonSales;
            
            modal.classList.remove('hidden');
        }

        async function finishShift(e) {
            e.preventDefault();
            const m = document.getElementById('closeShiftModal');
            const actual = parseInt(document.getElementById('actualCash').value);
            const diff = actual - parseInt(m.dataset.expected);

            const report = {
                shiftId: activeShift.id,
                cashierName: activeShift.cashierName,
                openTime: activeShift.startTime,
                startCash: activeShift.startCash,
                expectedCashSales: parseInt(m.dataset.cashSales),
                totalQris: parseInt(m.dataset.qrisSales),
                totalKasbon: parseInt(m.dataset.kasbonSales),
                actualCash: actual,
                difference: diff,
                area: currentArea
            };

            try {
                // 1. Simpan ke Firebase
                await window.addDoc(window.collection(window.db, "shifts"), report);
                // 2. Simpan ke Google Sheet POS
                fetch(POS_API_URL, { method: 'POST', body: JSON.stringify({action: 'record_shift', data: report}) });
                
                // 3. Reset
                localStorage.removeItem('adamart_shift');
                activeShift = null;
                alert(`Shift Ditutup.\nSelisih: ${formatRp(diff)}\nSilakan refresh.`);
                location.reload();
            } catch(err) {
                alert("Error: " + err.message);
            }
        }


        // --- E-VOUCHER INTEGRATION LOGIC ---

        // 1. Load User Data (Background)
        async function loadEvoucherData() {
            const today = new Date();
            const period = `${today.getMonth() + 1}-${today.getFullYear()}`;
            try {
                const res = await fetch(`${EVOUCHER_API_URL}?periode=${period}`);
                const data = await res.json();
                if(Array.isArray(data)) evoucherUsers = data;
            } catch(e) { console.error("EVoucher Data Error", e); }
        }

        // 2. Cek User (Saat Kasir ketik NIK)
        function checkEvoucherUser() {
            const id = document.getElementById('kasbonSearchId').value.trim();
            if (!id) return showToast("Masukkan NIK/No Anggota", true);
            
            document.getElementById('kasbonLoading').classList.remove('hidden');

            // Helper local function
            const performCheck = () => {
                const user = evoucherUsers.find(u => String(u.noAnggota) === id || String(u.nik) === id);
                document.getElementById('kasbonLoading').classList.add('hidden');

                if(user) {
                    document.getElementById('evUserInfo').classList.remove('hidden');
                    document.getElementById('evUserName').textContent = user.name;
                    document.getElementById('evUserNIK').textContent = user.nik;
                    
                    const remaining = user.limit - (user.used || 0);
                    const totalCart = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
                    
                    document.getElementById('evUserLimit').textContent = formatRp(remaining);
                    document.getElementById('evFoundUser').value = JSON.stringify(user);
                    
                    const btn = document.getElementById('evSubmitBtn');
                    if (remaining < totalCart) {
                        document.getElementById('evUserLimit').className = 'font-bold text-red-600 text-xl';
                        btn.disabled = true;
                        btn.textContent = "Limit Tidak Cukup";
                        btn.classList.add('bg-gray-400'); btn.classList.remove('bg-green-600');
                    } else {
                        document.getElementById('evUserLimit').className = 'font-bold text-green-600 text-xl';
                        btn.disabled = false;
                        btn.textContent = "Konfirmasi Pembayaran";
                        btn.classList.remove('bg-gray-400'); btn.classList.add('bg-green-600');
                    }
                } else {
                    showToast("Anggota tidak ditemukan!", true);
                }
            };

            if(evoucherUsers.length === 0) loadEvoucherData().then(performCheck);
            else performCheck();
        }

        // 3. Proses Transaksi Kasbon (Integrasi)
        function processKasbonTransaction() {
            const userStr = document.getElementById('evFoundUser').value;
            if(!userStr) return;
            
            const user = JSON.parse(userStr);
            const totalCart = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            
            // Validasi ulang
            if ((user.limit - (user.used || 0)) < totalCart) return alert("Limit tidak mencukupi.");

            const evPayload = {
                idUser: user.noAnggota !== '-' ? user.noAnggota : user.nik,
                nama: user.name,
                merchant: "Adamart POS (" + currentArea + ")",
                nominal: totalCart,
                keterangan: "Belanja di " + currentArea,
                kodeVoucher: "KA" + Math.floor(Date.now() / 1000),
                periode: `${new Date().getMonth() + 1}-${new Date().getFullYear()}`,
                tanggal: new Date().toISOString().split('T')[0],
                id: "TX-" + Date.now()
            };

            document.getElementById('kasbonLoading').classList.remove('hidden');

            // A. Kirim ke E-Voucher System
            fetch(EVOUCHER_API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(evPayload)
            }).then(() => {
                // B. Jika sukses, Lanjutkan catat di POS
                document.getElementById('kasbonLoading').classList.add('hidden');
                closeKasbonModal();
                
                // Panggil fungsi transaksi utama (Firebase + Sheet POS)
                executeTransaction({
                    memberNumber: `${user.name} (${user.noAnggota})`,
                    minePermit: user.nik 
                });
            }).catch(err => {
                document.getElementById('kasbonLoading').classList.add('hidden');
                alert("Gagal koneksi E-Voucher: " + err.message);
            });
        }


        // --- MAIN TRANSACTION LOGIC ---

        function processTransaction() {
            if(selectedPaymentMethod === 'Kasbon') {
                // Buka Modal E-Voucher
                document.getElementById('kasbonSearchId').value = '';
                document.getElementById('evUserInfo').classList.add('hidden');
                document.getElementById('evSubmitBtn').disabled = true;
                // document.getElementById('evTotalAmount').textContent = document.getElementById('totalAmount').textContent;
                // FIX: Gunakan ID yang benar
                document.getElementById('evTotalAmountDisplay').textContent = document.getElementById('totalAmount').textContent;
                document.getElementById('kasbonModal').classList.remove('hidden');
            } else {
                // Tunai / QRIS langsung proses
                executeTransaction();
            }
        }

        async function executeTransaction(extraData = {}) {
            if (!activeShift) return alert("ERROR: Shift belum dibuka!");
            
            try {
                const data = {
                    area: currentArea,
                    shiftId: activeShift.id,
                    items: cart.map(i => `${i.name} x${i.quantity}`).join(', '),
                    total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
                    method: selectedPaymentMethod,
                    cart: cart,
                    ...extraData,
                    timestamp: new Date().toISOString()
                };

                // 1. Simpan ke Firestore (Realtime)
                await window.addDoc(window.collection(window.db, "sales"), data);
                
                // 2. Update Stok di Firestore
                const stockKey = `Stok Area Kasir ${currentArea}`;
                for (const item of cart) { 
                    const productRef = window.doc(window.db, "products", item.docId); 
                    await window.updateDoc(productRef, { [stockKey]: window.increment(-item.quantity) }); 
                }
                
                // 3. Backup ke Google Sheet POS (Background)
                fetch(POS_API_URL, { method: 'POST', body: JSON.stringify({action: 'record_sale', data: data}) }).catch(console.error);
                
                // 4. Selesai
                lastTransaction = data;
                showReceipt();
                resetTransaction();
                showToast("Transaksi Berhasil!");
                loadProducts(); // Refresh stok di layar
            } catch (e) { 
                console.error(e); 
                showToast("Gagal transaksi", true); 
            }
        }

        // --- UI HELPERS ---
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700'));
            document.getElementById('pay' + method).classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700');
            
            // Update text tombol bayar
            const btn = document.getElementById('checkoutBtn');
            if (method === 'Kasbon') btn.textContent = "Lanjut ke Validasi Anggota";
            else btn.textContent = "Bayar Sekarang";
            
            updateCartDisplay();
        }

        function closeKasbonModal() { document.getElementById('kasbonModal').classList.add('hidden'); }
        function closeReceiptModal() { document.getElementById('receiptModal').classList.add('hidden'); }
        
        // ... (Sisa fungsi helper seperti loadProducts, addToCart, dll sama seperti sebelumnya) ...
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('productSelect').addEventListener('change', selectProduct);
            loadEvoucherData();
        });

        async function selectArea(area) {
            currentArea = area;
            document.getElementById('areaSelection').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            const checkDb = setInterval(async () => { if (window.db) { clearInterval(checkDb); await loadProducts(); document.getElementById('loadingScreen').classList.add('hidden'); document.getElementById('cashierInterface').classList.remove('hidden'); document.getElementById('currentArea').textContent = `Area: ${area}`; initShift(); } }, 100);
        }
        
        async function loadProducts() { try { const q = window.query(window.collection(window.db, "products")); const querySnapshot = await window.getDocs(q); const products = []; querySnapshot.forEach((doc) => { products.push({ id: doc.id, ...doc.data() }); }); const stockKey = `Stok Area Kasir ${currentArea}`; availableProducts = products.filter(p => (p[stockKey] || 0) > 0); populateSelects(); displayProducts(); } catch (e) { console.error("Firebase Error:", e); showToast("Gagal memuat data", true); } }
        function populateSelects() { const s = document.getElementById('productSelect'); s.innerHTML = '<option value="">Pilih...</option>'; availableProducts.forEach(p => { const opt = document.createElement('option'); opt.value = p.Barcode; opt.textContent = `${p['Nama Produk']} - Rp ${p.Harga}`; s.appendChild(opt); }); }
        function displayProducts(products = availableProducts) { const k = `Stok Area Kasir ${currentArea}`; document.getElementById('productGrid').innerHTML = products.map(p => `<div class="bg-white p-3 rounded-lg shadow border hover:border-blue-500 transition cursor-pointer" onclick="addToCart('${String(p.Barcode).replace(/'/g, "\\'")}')"><div><h4 class="font-bold text-gray-800 text-sm truncate">${p['Nama Produk']}</h4><div class="flex justify-between items-center mt-2"><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${p.Barcode}</span><span class="text-xs font-bold text-gray-500">Stok: ${p[k]}</span></div><p class="text-blue-600 font-bold mt-2 text-sm">Rp ${p.Harga.toLocaleString('id-ID')}</p></div></div>`).join(''); }
        function filterProducts() { const term = document.getElementById('productSearch').value.toLowerCase(); const filtered = availableProducts.filter(p => String(p['Nama Produk']).toLowerCase().includes(term) || String(p.Barcode).toLowerCase().includes(term)); displayProducts(filtered); }
        function selectProduct() { const val = document.getElementById('productSelect').value; if(val) { addToCart(val); document.getElementById('productSelect').value = ''; } }
        function addToCart(barcode) { const product = availableProducts.find(p => String(p.Barcode) == String(barcode)); if (!product) return showToast("Produk error", true); const existing = cart.find(i => String(i.barcode) == String(barcode)); if(existing) existing.quantity++; else cart.push({ barcode: product.Barcode, name: product['Nama Produk'], price: product.Harga, quantity: 1, docId: product.id }); updateCartDisplay(); showToast("Produk masuk"); }
        function updateCartDisplay() { 
            const container = document.getElementById('cartItems'); 
            const totalEl = document.getElementById('totalAmount'); 
            const btn = document.getElementById('checkoutBtn'); 
            const evTotal = document.getElementById('evTotalAmountDisplay'); 

            if (!container) return; 
            
            let total = 0; 
            if (cart.length === 0) container.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">Keranjang Kosong</div>'; 
            else container.innerHTML = cart.map((item, idx) => { 
                total += item.price * item.quantity; 
                return `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm"><div class="flex-1"><div class="font-bold truncate">${item.name}</div><div class="text-xs text-gray-500">Rp ${item.price} x ${item.quantity}</div></div><div class="flex gap-1 items-center"><button onclick="modQty(${idx}, -1)" class="w-5 h-5 bg-red-100 text-red-600 rounded flex items-center justify-center">-</button><span class="font-bold w-6 text-center">${item.quantity}</span><button onclick="modQty(${idx}, 1)" class="w-5 h-5 bg-green-100 text-green-600 rounded flex items-center justify-center">+</button></div></div>`; 
            }).join(''); 
            
            if(totalEl) totalEl.textContent = formatRp(total); 
            if(btn) btn.disabled = cart.length === 0 || !selectedPaymentMethod; 
            if(evTotal) evTotal.textContent = formatRp(total); 
        }
        function modQty(idx, change) { cart[idx].quantity += change; if(cart[idx].quantity <= 0) cart.splice(idx, 1); updateCartDisplay(); }
        function showReceipt() { const t = lastTransaction; if(!t) return; let h = `<div class="text-center font-bold">ADAMART</div><div class="text-xs text-center">${new Date().toLocaleString()}</div><hr class="my-2">`; t.cart.forEach(i => h+=`<div class="flex justify-between text-sm"><span>${i.name} x${i.quantity}</span><span>${(i.price*i.quantity).toLocaleString()}</span></div>`); h+=`<hr class="my-2"><div class="flex justify-between font-bold"><span>TOTAL</span><span>${t.total.toLocaleString()}</span></div><div class="flex justify-between text-sm mt-1"><span>Bayar</span><span>${t.method}</span></div>`; if(t.memberNumber) h += `<div class="mt-3 pt-2 border-t border-dashed text-xs"><div class="font-bold">KASBON INFO</div><div>User: ${t.memberNumber}</div></div>`; document.getElementById('receiptContent').innerHTML = h; document.getElementById('receiptModal').classList.remove('hidden'); }
        function sendToWhatsApp() { const t = lastTransaction; if(!t) return; let m = `*ADAMART POS*\nArea: ${t.area}\nDate: ${new Date().toLocaleString()}\n----------------\n`; t.cart.forEach(i => m+=`${i.name} x${i.quantity}\n`); m+=`Total: ${t.total}`; window.open(`https://wa.me/?text=${encodeURIComponent(m)}`); }
        
        // --- ADDED MISSING FUNCTIONS ---

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm("Hapus semua item dari keranjang?")) {
                cart = [];
                updateCartDisplay();
                showToast("Keranjang dikosongkan", true);
            }
        }

        function changeArea() {
            if (confirm("Ganti area kerja?")) {
                location.reload();
            }
        }

        function resetTransaction() {
            cart = [];
            selectedPaymentMethod = '';
            // Reset payment buttons
            document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700'));
            const btn = document.getElementById('checkoutBtn');
            if(btn) {
                btn.textContent = "Bayar Sekarang";
                btn.disabled = true;
            }
            updateCartDisplay();
        }

        function showReceivingModal() {
            alert("Fitur Penerimaan Barang (Receiving) belum aktif di versi ini.");
        }

        function showRequisitionModal() {
            alert("Fitur Permintaan Barang (Requisition) belum aktif di versi ini.");
        }

        // Expose
        window.addToCart = addToCart;
        window.modQty = modQty;
        window.clearCart = clearCart;
        window.selectPaymentMethod = selectPaymentMethod;
        window.processTransaction = processTransaction;
        window.closeShiftModal = closeShiftModal;
        window.startShift = startShift;
        window.finishShift = finishShift;
        window.closeKasbonModal = closeKasbonModal;
        window.closeReceiptModal = closeReceiptModal;
        window.sendToWhatsApp = sendToWhatsApp;
        window.selectArea = selectArea;
        window.changeArea = changeArea;
        window.checkEvoucherUser = checkEvoucherUser;
        window.processKasbonTransaction = processKasbonTransaction;
        window.showReceivingModal = showReceivingModal;
        window.showRequisitionModal = showRequisitionModal;
        window.resetTransaction = resetTransaction;
    </script>
</body>
</html>
